<?!= include('SharedComponents'); ?>

<script>
(function() {
  // === Standardized Table Component ===
  function StandardTable(props) {
    var columns = props.columns;
    var data = props.data;
    var onRowClick = props.onRowClick;

    return React.createElement('div', { className: 'bg-white rounded-lg shadow overflow-hidden' },
      React.createElement('table', { className: 'w-full' }, [
        React.createElement('thead', { key: 'thead' }, 
          React.createElement('tr', { key: 'header-row' }, 
            columns.map((column, index) => 
              React.createElement('th', {
                key: `header-${index}`,
                className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider'
              }, column.header || column.label)
            )
          )
        ),
        React.createElement('tbody', { key: 'tbody' }, 
          data.map((row, rowIndex) => 
            React.createElement('tr', {
              key: `row-${rowIndex}`,
              onClick: onRowClick ? () => onRowClick(row) : undefined,
              className: onRowClick ? 'cursor-pointer hover:bg-gray-50' : ''
            }, 
              columns.map((column, colIndex) => 
                React.createElement('td', {
                  key: `cell-${rowIndex}-${colIndex}`,
                  className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500'
                }, 
                  // Handle different column property patterns
                  column.cell ? column.cell(row) : 
                  column.render ? column.render(row) : 
                  row[column.key] || ''
                )
              )
            )
          )
        )
      ])
    );
  }

  // === Create Subcontractor Form Component ===
  function CreateSubcontractorForm(props) {
    var onSubmit = props.onSubmit;
    var onCancel = props.onCancel;
    var useState = React.useState;
    
    var formDataState = useState({
      subName: '',
      address: '',
      city: '',
      state: '',
      zip: '',
      contactEmail: '',
      phone: ''
    });
    var formData = formDataState[0];
    var setFormData = formDataState[1];

    var errorState = useState(null);
    var error = errorState[0];
    var setError = errorState[1];
    
    var constantsState = useState(null);
    var constants = constantsState[0];
    var setConstants = constantsState[1];
    
    React.useEffect(function() {
      loadConstants();
    }, []);
    
    function loadConstants() {
      google.script.run
        .withSuccessHandler(function(result) {
          setConstants(result);
        })
        .withFailureHandler(function(err) {
          setError(err.message || 'Error loading constants');
        })
        .getClientConstants();
    }

    function handleSubmit(e) {
      e.preventDefault();
      if (!formData.subName.trim()) {
        setError('Subcontractor name is required');
        return;
      }
      onSubmit(formData);
    }

    // Phone number formatter
    function formatPhoneNumber(value) {
      var cleaned = value.replace(/\D/g, '');
      if (cleaned.length >= 10) {
        return '(' + cleaned.slice(0,3) + ') ' + cleaned.slice(3,6) + '-' + cleaned.slice(6,10);
      } else if (cleaned.length > 6) {
        return '(' + cleaned.slice(0,3) + ') ' + cleaned.slice(3,6) + '-' + cleaned.slice(6);
      } else if (cleaned.length > 3) {
        return '(' + cleaned.slice(0,3) + ') ' + cleaned.slice(3);
      } else if (cleaned.length > 0) {
        return '(' + cleaned;
      }
      return cleaned;
    }

    return React.createElement('div', { className: 'space-y-4 bg-white p-6 rounded-lg shadow' }, [
      React.createElement('h3', { className: 'text-lg font-semibold' }, 'Create New Subcontractor'),
      error && React.createElement('div', { 
        className: 'text-red-500 text-sm p-2 bg-red-50 rounded'
      }, error),
      React.createElement('form', { onSubmit: handleSubmit, className: 'space-y-4' }, [
        // Subcontractor Name (required)
        React.createElement('div', null, [
          React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Subcontractor Name *'),
          React.createElement('input', {
            type: 'text',
            required: true,
            value: formData.subName,
            onChange: function(e) {
              setFormData(function(prev) {
                var newData = Object.assign({}, prev);
                newData.subName = e.target.value;
                return newData;
              });
            },
            className: 'w-full p-2 border rounded'
          })
        ]),
        // Address
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Address'),
          React.createElement('input', {
            type: 'text',
            value: formData.address,
            onChange: function(e) {
              setFormData(function(prev) {
                var newData = Object.assign({}, prev);
                newData.address = e.target.value;
                return newData;
              });
            },
            className: 'w-full p-2 border rounded'
          })
        ),
        // City, State, Zip
        React.createElement('div', { className: 'grid grid-cols-3 gap-4' },
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'City'),
            React.createElement('input', {
              type: 'text',
              value: formData.city,
              onChange: function(e) {
                setFormData(function(prev) {
                  var newData = Object.assign({}, prev);
                  newData.city = e.target.value;
                  return newData;
                });
              },
              className: 'w-full p-2 border rounded'
            })
          ),
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'State'),
            React.createElement(SharedUI.Select, {
              value: formData.state,
              onChange: function(e) {
                setFormData(function(prev) {
                  var newData = Object.assign({}, prev);
                  newData.state = e.target.value;
                  return newData;
                });
              },
              options: constants?.US_STATES || [],
              placeholder: 'Select state',
              className: 'w-full p-2 border rounded'
            })
          ),
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'ZIP'),
            React.createElement('input', {
              type: 'text',
              maxLength: 5,
              value: formData.zip,
              onChange: function(e) {
                setFormData(function(prev) {
                  var newData = Object.assign({}, prev);
                  newData.zip = e.target.value.replace(/\D/g, '').slice(0, 5);
                  return newData;
                });
              },
              className: 'w-full p-2 border rounded'
            })
          )
        ),
        // Contact Info
        React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Phone'),
            React.createElement('input', {
              type: 'tel',
              value: formData.phone,
              onChange: function(e) {
                var formatted = formatPhoneNumber(e.target.value);
                setFormData(function(prev) {
                  var newData = Object.assign({}, prev);
                  newData.phone = formatted;
                  return newData;
                });
              },
              className: 'w-full p-2 border rounded'
            })
          ),
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Email'),
            React.createElement('input', {
              type: 'email',
              value: formData.contactEmail,
              onChange: function(e) {
                setFormData(function(prev) {
                  var newData = Object.assign({}, prev);
                  newData.contactEmail = e.target.value;
                  return newData;
                });
              },
              className: 'w-full p-2 border rounded'
            })
          )
        ),
        // Buttons
        React.createElement('div', { className: 'flex justify-end space-x-4 pt-4' }, [
          React.createElement('button', {
            type: 'button',
            onClick: onCancel,
            className: 'px-4 py-2 border rounded hover:bg-gray-50'
          }, 'Cancel'),
          React.createElement('button', {
            type: 'submit',
            className: 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700'
          }, 'Create Subcontractor')
        ])
      ])
    ]);
  }

  // === Edit Subcontractor Form Component ===
  const EditSubcontractorForm = ({ subcontractor, onSubmit, onCancel }) => {
    console.log('Rendering EditSubcontractorForm with subcontractor:', subcontractor);
    
    if (!subcontractor) {
      console.error('EditSubcontractorForm called with no subcontractor data');
      return React.createElement('div', { className: 'p-4 bg-red-100 text-red-700 rounded' }, 
        'Error: No subcontractor data available'
      );
    }

    const [formData, setFormData] = React.useState({
      subId: subcontractor.subId || '',
      subName: subcontractor.subName || '',
      address: subcontractor.address || '',
      city: subcontractor.city || '',
      state: subcontractor.state || '',
      zip: subcontractor.zip || '',
      contactEmail: subcontractor.contactEmail || '',
      phone: subcontractor.phone || ''
    });

    const handleSubmit = (e) => {
      e.preventDefault();
      onSubmit(formData);
    };

    // Phone number formatter
    const formatPhoneNumber = (value) => {
      const cleaned = value.replace(/\D/g, '');
      if (cleaned.length >= 10) {
        return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6,10)}`;
      } else if (cleaned.length > 6) {
        return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
      } else if (cleaned.length > 3) {
        return `(${cleaned.slice(0,3)}) ${cleaned.slice(3)}`;
      } else if (cleaned.length > 0) {
        return `(${cleaned}`;
      }
      return cleaned;
    };

    return React.createElement('div', { className: 'space-y-4 bg-white p-6 rounded-lg shadow' },
      React.createElement('h3', { className: 'text-lg font-semibold' }, 'Edit Subcontractor'),
      React.createElement('form', { onSubmit: handleSubmit, className: 'space-y-4' },
        // Subcontractor Name (required)
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Subcontractor Name *'),
          React.createElement('input', {
            type: 'text',
            required: true,
            value: formData.subName,
            onChange: e => setFormData(prev => ({ ...prev, subName: e.target.value })),
            className: 'w-full p-2 border rounded'
          })
        ),
        // Address
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Address'),
          React.createElement('input', {
            type: 'text',
            value: formData.address,
            onChange: e => setFormData(prev => ({ ...prev, address: e.target.value })),
            className: 'w-full p-2 border rounded'
          })
        ),
        // City, State, Zip
        React.createElement('div', { className: 'grid grid-cols-3 gap-4' },
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'City'),
            React.createElement('input', {
              type: 'text',
              value: formData.city,
              onChange: e => setFormData(prev => ({ ...prev, city: e.target.value })),
              className: 'w-full p-2 border rounded'
            })
          ),
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'State'),
            React.createElement('input', {
              type: 'text',
              maxLength: 2,
              value: formData.state,
              onChange: e => setFormData(prev => ({ ...prev, state: e.target.value.toUpperCase() })),
              className: 'w-full p-2 border rounded'
            })
          ),
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'ZIP'),
            React.createElement('input', {
              type: 'text',
              maxLength: 5,
              value: formData.zip,
              onChange: e => setFormData(prev => ({ 
                ...prev, 
                zip: e.target.value.replace(/\D/g, '').slice(0, 5)
              })),
              className: 'w-full p-2 border rounded'
            })
          )
        ),
        // Contact Info
        React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Phone'),
            React.createElement('input', {
              type: 'tel',
              value: formData.phone,
              onChange: e => setFormData(prev => ({ 
                ...prev, 
                phone: formatPhoneNumber(e.target.value)
              })),
              className: 'w-full p-2 border rounded'
            })
          ),
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Email'),
            React.createElement('input', {
              type: 'email',
              value: formData.contactEmail,
              onChange: e => setFormData(prev => ({ ...prev, contactEmail: e.target.value })),
              className: 'w-full p-2 border rounded'
            })
          )
        ),
        // Buttons
        React.createElement('div', { className: 'flex justify-end space-x-4 pt-4' },
          React.createElement('button', {
            type: 'button',
            onClick: onCancel,
            className: 'px-4 py-2 border rounded hover:bg-gray-50'
          }, 'Cancel'),
          React.createElement('button', {
            type: 'submit',
            className: 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700'
          }, 'Update Subcontractor')
        )
      )
    );
  };

  // === Main SubcontractorManagement Component ===
  const SubcontractorManagementComponent = () => {
    const [subcontractors, setSubcontractors] = React.useState([]);
    const [loading, setLoading] = React.useState(true);
    const [error, setError] = React.useState(null);
    const [selectedSubcontractor, setSelectedSubcontractor] = React.useState(null);
    const [showForm, setShowForm] = React.useState(false);
    const [showSummary, setShowSummary] = React.useState(false);
    const [formData, setFormData] = React.useState({
      name: '',
      contact: '',
      email: '',
      phone: '',
      specialties: '',
      status: 'ACTIVE' // Default status
    });
    const [constants, setConstants] = React.useState(null);

    // Load subcontractors and constants on mount
    React.useEffect(() => {
      loadSubcontractors();
      loadConstants();
    }, []);

    const loadSubcontractors = () => {
      setLoading(true);
      google.script.run
        .withSuccessHandler(handleSubcontractorsLoaded)
        .withFailureHandler(handleError)
        .getSubcontractors();
    };

    const loadConstants = () => {
      google.script.run
        .withSuccessHandler(handleConstantsLoaded)
        .withFailureHandler(handleError)
        .getClientConstants();
    };

    const handleConstantsLoaded = (result) => {
      setConstants(result);
    };

    const handleSubcontractorsLoaded = (result) => {
      setSubcontractors(result || []);
      setLoading(false);
    };

    const handleError = (error) => {
      setError(error.message || 'An error occurred');
      setLoading(false);
    };

    const handleSubmit = (e) => {
      e.preventDefault();
      setLoading(true);

      const subcontractorData = selectedSubcontractor 
        ? { ...formData, id: selectedSubcontractor.id }
        : formData;

      google.script.run
        .withSuccessHandler(() => {
          loadSubcontractors();
          setShowForm(false);
          setSelectedSubcontractor(null);
          setFormData({
            name: '',
            contact: '',
            email: '',
            phone: '',
            specialties: '',
            status: 'ACTIVE'
          });
        })
        .withFailureHandler(handleError)
        [selectedSubcontractor ? 'updateSubcontractor' : 'createSubcontractor'](subcontractorData);
    };

    const handleEdit = (subcontractor) => {
      setSelectedSubcontractor(subcontractor);
      setFormData({
        name: subcontractor.subName || '',
        contact: subcontractor.contactPerson || '',
        email: subcontractor.contactEmail || '',
        phone: subcontractor.phone || '',
        specialties: subcontractor.specialties || '',
        status: subcontractor.status || 'ACTIVE'
      });
      setShowForm(true);
      setShowSummary(false);
    };

    const handleRowClick = (subcontractor) => {
      setSelectedSubcontractor(subcontractor);
      setShowSummary(true);
      setShowForm(false);
    };

    const handleDelete = (subcontractorId) => {
      if (!confirm('Are you sure you want to delete this subcontractor?')) return;
      
      setLoading(true);
      google.script.run
        .withSuccessHandler(loadSubcontractors)
        .withFailureHandler(handleError)
        .deleteSubcontractor(subcontractorId);
    };

    // New Subcontractor Summary Component
    const SubcontractorSummary = () => {
      if (!selectedSubcontractor) return null;
      
      const [details, setDetails] = React.useState(null);
      const [isLoading, setIsLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      
      // Simple formatCurrency function to use locally
      const formatCurrency = (amount) => {
        if (!amount && amount !== 0) return '$0.00';
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
        }).format(amount);
      };
      
      React.useEffect(() => {
        // Remove the formatCurrency server call since we don't need it
        
        // Just load subcontractor details
        setIsLoading(true);
        google.script.run
          .withSuccessHandler((result) => {
            if (result.success) {
              setDetails(result.data);
            } else {
              setError(result.error || 'Failed to load subcontractor details');
            }
            setIsLoading(false);
          })
          .withFailureHandler((err) => {
            setError(err.message || 'An error occurred');
            setIsLoading(false);
          })
          .getSubcontractorDetailsForClient(selectedSubcontractor.subId);
      }, [selectedSubcontractor.subId]);

      if (isLoading) {
        return React.createElement('div', { 
          key: 'loading-container',
          className: 'text-center py-8' 
        }, 'Loading details...');
      }

      if (error) {
        return React.createElement('div', { 
          key: 'error-container',
          className: 'text-red-600 py-4' 
        }, error);
      }

      if (!details) {
        return React.createElement('div', { 
          key: 'no-details-container',
          className: 'text-gray-500 py-4' 
        }, 'No details available');
      }

      return React.createElement('div', { 
        key: 'summary-container',
        className: 'bg-white rounded-lg shadow p-6 space-y-6' 
      }, [
        // Header with actions
        React.createElement('div', { 
          key: 'header',
          className: 'flex justify-between items-center border-b pb-4' 
        }, [
          React.createElement('h3', { 
            key: 'title',
            className: 'text-xl font-semibold' 
          }, details.subName || 'Subcontractor Details'),
          React.createElement('div', { 
            key: 'actions',
            className: 'flex space-x-3' 
          }, [
            React.createElement('button', {
              key: 'edit-btn',
              onClick: () => handleEdit(selectedSubcontractor),
              className: 'px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700'
            }, 'Edit'),
            React.createElement('button', {
              key: 'close-btn',
              onClick: () => setShowSummary(false),
              className: 'px-3 py-1 border rounded hover:bg-gray-50'
            }, 'Close')
          ])
        ]),
        
        // Main content - 2 columns on larger screens
        React.createElement('div', { 
          key: 'content',
          className: 'grid grid-cols-1 md:grid-cols-2 gap-6' 
        }, [
          // Left column - Contact info
          React.createElement('div', { key: 'contact-info' }, [
            React.createElement('h4', { 
              key: 'contact-header',
              className: 'font-medium text-gray-700 mb-3' 
            }, 'Contact Information'),
            
            React.createElement('div', { 
              key: 'contact-details',
              className: 'space-y-2' 
            }, [
              details.subId && React.createElement('div', { 
                key: 'sub-id-row',
                className: 'flex items-start' 
              }, [
                React.createElement('div', { 
                  key: 'sub-id-label',
                  className: 'text-gray-500 w-24' 
                }, 'Sub ID:'),
                React.createElement('div', { 
                  key: 'sub-id-value',
                  className: 'font-mono' 
                }, details.subId)
              ]),
              
              details.contactEmail && React.createElement('div', { 
                key: 'email-row',
                className: 'flex items-start' 
              }, [
                React.createElement('div', { 
                  key: 'email-label',
                  className: 'text-gray-500 w-24' 
                }, 'Email:'),
                React.createElement('div', { key: 'email-value' }, details.contactEmail)
              ]),
              
              details.phone && React.createElement('div', { 
                key: 'phone-row',
                className: 'flex items-start' 
              }, [
                React.createElement('div', { 
                  key: 'phone-label',
                  className: 'text-gray-500 w-24' 
                }, 'Phone:'),
                React.createElement('div', { key: 'phone-value' }, details.phone)
              ]),
              
              React.createElement('div', { 
                key: 'address-row',
                className: 'flex items-start' 
              }, [
                React.createElement('div', { 
                  key: 'address-label',
                  className: 'text-gray-500 w-24' 
                }, 'Address:'),
                React.createElement('div', { key: 'address-container' }, [
                  details.address && React.createElement('div', { 
                    key: 'address-line' 
                  }, details.address),
                  (details.city || details.state || details.zip) && 
                  React.createElement('div', { 
                    key: 'city-state-zip' 
                  }, [
                    details.city || '',
                    details.state ? `, ${details.state}` : '',
                    details.zip ? ` ${details.zip}` : ''
                  ].join(''))
                ])
              ])
            ])
          ]),
          
          // Right column - Statistics
          React.createElement('div', { key: 'statistics' }, [
            React.createElement('h4', { 
              key: 'stats-header',
              className: 'font-medium text-gray-700 mb-3' 
            }, 'Activity Summary'),
            
            React.createElement('div', { 
              key: 'stats-grid',
              className: 'grid grid-cols-2 gap-4' 
            }, [
              // Invoice Count
              React.createElement('div', { 
                key: 'invoice-count',
                className: 'bg-gray-50 p-3 rounded' 
              }, [
                React.createElement('div', { 
                  key: 'invoice-count-label',
                  className: 'text-sm text-gray-500' 
                }, 'Total Invoices'),
                React.createElement('div', { 
                  key: 'invoice-count-value',
                  className: 'text-xl font-semibold' 
                }, details.metrics.invoiceCount)
              ]),
              
              // Total Amount
              React.createElement('div', { 
                key: 'total-amount',
                className: 'bg-gray-50 p-3 rounded' 
              }, [
                React.createElement('div', { 
                  key: 'total-amount-label',
                  className: 'text-sm text-gray-500' 
                }, 'Total Invoiced'),
                React.createElement('div', { 
                  key: 'total-amount-value',
                  className: 'text-xl font-semibold' 
                }, formatCurrency(details.metrics.totalInvoiced))
              ]),
              
              // Active Projects
              React.createElement('div', { 
                key: 'active-projects',
                className: 'bg-gray-50 p-3 rounded' 
              }, [
                React.createElement('div', { 
                  key: 'active-projects-label',
                  className: 'text-sm text-gray-500' 
                }, 'Active Projects'),
                React.createElement('div', { 
                  key: 'active-projects-value',
                  className: 'text-xl font-semibold' 
                }, details.metrics.activeProjects)
              ]),
              
              // Completed Projects
              React.createElement('div', { 
                key: 'completed-projects',
                className: 'bg-gray-50 p-3 rounded' 
              }, [
                React.createElement('div', { 
                  key: 'completed-projects-label',
                  className: 'text-sm text-gray-500' 
                }, 'Completed Projects'),
                React.createElement('div', { 
                  key: 'completed-projects-value',
                  className: 'text-xl font-semibold' 
                }, details.metrics.completedProjects)
              ])
            ])
          ])
        ]),
        
        // Recent Invoices Section
        React.createElement('div', { key: 'recent-invoices', className: 'pt-4 border-t' }, [
          React.createElement('h4', { 
            key: 'recent-invoices-title',
            className: 'font-medium text-gray-700 mb-3' 
          }, 'Recent Invoices'),
          
          details.recentInvoices.length === 0 ?
            React.createElement('div', { 
              key: 'no-invoices',
              className: 'text-gray-500 py-4' 
            }, 'No recent invoices found.') :
            React.createElement('div', { 
              key: 'invoices-table-container',
              className: 'overflow-x-auto' 
            }, 
              React.createElement('table', { 
                key: 'invoices-table',
                className: 'min-w-full' 
              }, [
                React.createElement('thead', { key: 'thead' },
                  React.createElement('tr', { key: 'header-row', className: 'bg-gray-50' }, [
                    React.createElement('th', { key: 'date-header', className: 'px-4 py-2 text-left text-xs font-medium text-gray-500' }, 'Date'),
                    React.createElement('th', { key: 'project-header', className: 'px-4 py-2 text-left text-xs font-medium text-gray-500' }, 'Project'),
                    React.createElement('th', { key: 'amount-header', className: 'px-4 py-2 text-left text-xs font-medium text-gray-500' }, 'Amount'),
                    React.createElement('th', { key: 'status-header', className: 'px-4 py-2 text-left text-xs font-medium text-gray-500' }, 'Status')
                  ])
                ),
                React.createElement('tbody', { key: 'tbody' },
                  details.recentInvoices.map((invoice, index) => 
                    React.createElement('tr', { 
                      key: `invoice-row-${invoice.date}-${index}`,
                      className: index % 2 === 0 ? 'bg-white' : 'bg-gray-50'
                    }, [
                      React.createElement('td', { key: `date-${index}`, className: 'px-4 py-2' }, 
                        new Date(invoice.date).toLocaleDateString()
                      ),
                      React.createElement('td', { key: `project-${index}`, className: 'px-4 py-2' }, 
                        details.projects.find(p => p.projectId === invoice.projectId)?.name || invoice.projectId
                      ),
                      React.createElement('td', { key: `amount-${index}`, className: 'px-4 py-2' }, 
                        formatCurrency(invoice.amount)
                      ),
                      React.createElement('td', { key: `status-${index}`, className: 'px-4 py-2' }, 
                        invoice.status
                      )
                    ])
                  )
                )
              ])
            )
        ])
      ]);
    };

    // Subcontractor Form Component
    const SubcontractorForm = () => {
      // Format phone number as user types
      const handlePhoneChange = (e) => {
        const value = e.target.value;
        // Remove non-numeric characters
        const cleaned = value.replace(/\D/g, '');
        
        let formatted = '';
        if (cleaned.length > 0) {
          if (cleaned.length <= 3) {
            formatted = `(${cleaned}`;
          } else if (cleaned.length <= 6) {
            formatted = `(${cleaned.slice(0, 3)}) ${cleaned.slice(3)}`;
          } else {
            formatted = `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6, 10)}`;
          }
        }
        
        setFormData(prev => ({ ...prev, phone: formatted }));
      };

      return React.createElement('form', {
        onSubmit: handleSubmit,
        className: 'space-y-4'
      }, [
        React.createElement(SharedUI.Input, {
          key: 'name',
          label: 'Subcontractor Name',
          value: formData.name,
          onChange: (e) => setFormData(prev => ({ ...prev, name: e.target.value })),
          required: true
        }),
        React.createElement(SharedUI.Input, {
          key: 'contact',
          label: 'Contact Person',
          value: formData.contact,
          onChange: (e) => setFormData(prev => ({ ...prev, contact: e.target.value }))
        }),
        React.createElement(SharedUI.Input, {
          key: 'email',
          label: 'Email',
          type: 'email',
          value: formData.email,
          onChange: (e) => setFormData(prev => ({ ...prev, email: e.target.value }))
        }),
        React.createElement(SharedUI.Input, {
          key: 'phone',
          label: 'Phone',
          type: 'tel',
          value: formData.phone,
          onChange: handlePhoneChange
        }),
        React.createElement(SharedUI.Input, {
          key: 'specialties',
          label: 'Specialties',
          value: formData.specialties,
          onChange: (e) => setFormData(prev => ({ ...prev, specialties: e.target.value }))
        }),
        React.createElement(SharedUI.Select, {
          key: 'status',
          label: 'Status',
          value: formData.status,
          onChange: (e) => setFormData(prev => ({ ...prev, status: e.target.value })),
          options: constants?.SUBCONTRACTOR_STATUSES ? 
            Object.entries(constants.SUBCONTRACTOR_STATUSES).map(([_, value]) => value) : 
            ['ACTIVE', 'INACTIVE', 'PENDING', 'ARCHIVED'],
          required: true
        }),
        React.createElement('div', {
          key: 'buttons',
          className: 'flex flex-col sm:flex-row gap-4'
        }, [
          React.createElement(SharedUI.Button, {
            key: 'submit',
            text: selectedSubcontractor ? 'Update Subcontractor' : 'Add Subcontractor',
            type: 'submit'
          }),
          React.createElement(SharedUI.Button, {
            key: 'cancel',
            text: 'Cancel',
            variant: 'secondary',
            onClick: () => {
              setShowForm(false);
              setSelectedSubcontractor(null);
            }
          })
        ])
      ]);
    };

    // Subcontractor List Component
    const SubcontractorList = () => {
      // Add state for filtered subcontractors
      const [filteredSubcontractors, setFilteredSubcontractors] = React.useState(subcontractors);
      const [searchTerm, setSearchTerm] = React.useState('');
      
      // Update filtered subcontractors when search term or subcontractors change
      React.useEffect(() => {
        if (searchTerm.trim()) {
          const term = searchTerm.toLowerCase();
          setFilteredSubcontractors(
            subcontractors.filter(subcontractor => 
              (subcontractor.subName && subcontractor.subName.toLowerCase().includes(term)) ||
              (subcontractor.contactEmail && subcontractor.contactEmail.toLowerCase().includes(term)) ||
              (subcontractor.phone && subcontractor.phone.includes(searchTerm)) ||
              (subcontractor.address && subcontractor.address.toLowerCase().includes(term))
            )
          );
        } else {
          setFilteredSubcontractors(subcontractors);
        }
      }, [searchTerm, subcontractors]);
      
      if (!subcontractors.length) {
        return React.createElement(SharedUI.Card, {
          className: 'text-center py-8'
        }, [
          React.createElement('p', {
            key: 'no-subcontractors-text',
            className: 'text-gray-500'
          }, 'No subcontractors found'),
          React.createElement(SharedUI.Button, {
            key: 'add-button',
            text: 'Add Subcontractor',
            onClick: () => setShowForm(true),
            className: 'mt-4 max-w-xs mx-auto'
          })
        ]);
      }

      return React.createElement('div', {
        key: 'subcontractor-list-container',
        className: 'space-y-6'
      }, [
        // Controls row
        React.createElement('div', { 
          key: 'controls-row',
          className: 'flex flex-col sm:flex-row justify-between items-center gap-4 mb-6' 
        }, [
          React.createElement('input', {
            key: 'search-input',
            type: 'text',
            placeholder: 'Search subcontractors...',
            className: 'p-2 border rounded w-full sm:w-64',
            value: searchTerm,
            onChange: (e) => setSearchTerm(e.target.value)
          }),
          React.createElement(SharedUI.Button, {
            key: 'add-new-button',
            text: 'Add New Subcontractor',
            onClick: () => setShowForm(true)
          })
        ]),
        
        // Export button
        React.createElement('div', { 
          key: 'export-button-container',
          className: 'flex justify-end mb-4' 
        },
          React.createElement('button', {
            key: 'export-button',
            onClick: () => {
              // Simple CSV export
              const exportData = filteredSubcontractors.map(c => ({
                'Name': c.subName || '',
                'Email': c.contactEmail || '',
                'Phone': c.phone || '',
                'Address': c.address || '',
                'City': c.city || '',
                'State': c.state || '',
                'Zip': c.zip || '',
                'Status': c.status || ''
              }));
              
              if (exportData.length === 0) {
                alert('No data to export');
                return;
              }
              
              const headers = Object.keys(exportData[0]);
              const csvContent = [
                headers.join(','),
                ...exportData.map(row => 
                  headers.map(header => 
                    JSON.stringify(row[header] || '')
                  ).join(',')
                )
              ].join('\n');
              
              const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
              const link = document.createElement('a');
              if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `subcontractor_data_${new Date().toISOString()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              }
            },
            className: 'px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700'
          }, 'Export CSV')
        ),
        
        // Subcontractor cards container
        React.createElement('div', { 
          key: 'subcontractor-cards',
          className: 'space-y-4' 
        },
          filteredSubcontractors.map((subcontractor, index) => 
            React.createElement('div', {
              key: `subcontractor-card-${index}`,
              className: 'bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-md transition-shadow duration-200',
              onClick: () => handleRowClick(subcontractor)
            }, [
              React.createElement('div', { 
                key: 'card-content',
                className: 'flex flex-col md:flex-row justify-between items-start md:items-center'
              }, [
                // Left side - Subcontractor info
                React.createElement('div', { key: 'info-container', className: 'mb-4 md:mb-0' }, [
                  React.createElement('h3', { 
                    key: 'subcontractor-name',
                    className: 'text-lg font-semibold'
                  }, subcontractor.subName || 'Unnamed Subcontractor'),
                  
                  // Contact info
                  React.createElement('div', { key: `contact-info-${index}`, className: 'text-sm text-gray-500 mt-1' }, [
                    subcontractor.contactEmail && React.createElement('div', { key: `email-${index}` }, subcontractor.contactEmail),
                    subcontractor.phone && React.createElement('div', { key: `phone-${index}` }, subcontractor.phone)
                  ].filter(Boolean))
                ]),
                
                // Right side - Actions
                React.createElement('div', { key: 'actions-container', className: 'flex gap-2' }, [
                  React.createElement('button', {
                    key: 'edit-btn',
                    onClick: (e) => {
                      e.stopPropagation(); // Prevent row click
                      handleEdit(subcontractor);
                    },
                    className: 'px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300'
                  }, 'Edit'),
                  React.createElement('button', {
                    key: 'delete-btn',
                    onClick: (e) => {
                      e.stopPropagation(); // Prevent row click
                      handleDelete(subcontractor.subId);
                    },
                    className: 'px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700'
                  }, 'Delete')
                ])
              ])
            ])
          )
        )
      ]);
    };

    return React.createElement(SharedUI.Container, null, [
      React.createElement('h2', { 
        key: 'title',
        className: 'text-2xl font-bold mb-6' 
      }, 'Subcontractor Management'),
      
      // Loading State
      loading && React.createElement(SharedUI.LoadingOverlay, {
        key: 'loading-overlay'
      }),

      // Error Message
      error && React.createElement('div', {
        key: 'error-message',
        className: 'bg-red-100 text-red-700 p-4 rounded-lg mb-6'
      }, error),

      // Form Modal
      showForm && React.createElement(SharedUI.BottomSheet, {
        key: 'form-modal',
        isOpen: true,
        onClose: () => {
          setShowForm(false);
          setSelectedSubcontractor(null);
        },
        title: selectedSubcontractor ? 'Edit Subcontractor' : 'Add New Subcontractor'
      }, React.createElement(SubcontractorForm)),

      // Summary Modal - New addition
      showSummary && React.createElement('div', {
        key: 'summary-view',
        className: 'mt-6 mb-6'
      }, React.createElement(SubcontractorSummary)),

      // Main Content - Only show if not viewing summary
      !showForm && !showSummary && React.createElement(SubcontractorList, {
        key: 'subcontractor-list'
      })
    ].filter(Boolean));
  };

  // Expose to global scope
  window.SubcontractorManagementComponent = SubcontractorManagementComponent;
})();
</script>