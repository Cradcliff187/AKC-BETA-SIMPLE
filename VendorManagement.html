<script>
(function() {
  // === Standardized Loading Overlay ===
  const StandardLoadingOverlay = ({ message = 'Loading...' }) => {
    return React.createElement('div', {
      className: 'absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50'
    }, 
      React.createElement('div', { 
        className: 'text-center flex flex-col items-center justify-center' 
      },
        // Spinner SVG
        React.createElement('svg', {
          className: 'animate-spin h-10 w-10 text-blue-600 mb-4',
          xmlns: 'http://www.w3.org/2000/svg',
          fill: 'none',
          viewBox: '0 0 24 24'
        },
          React.createElement('circle', {
            className: 'opacity-25',
            cx: '12',
            cy: '12',
            r: '10',
            stroke: 'currentColor',
            strokeWidth: '4'
          }),
          React.createElement('path', {
            className: 'opacity-75',
            fill: 'currentColor',
            d: 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'
          })
        ),
        // Loading text
        React.createElement('span', { 
          className: 'text-lg text-gray-700 font-semibold' 
        }, message)
      )
    );
  };

  // === Standardized Table Component ===
  const StandardTable = ({ 
    columns,     // Array of column definitions
    data,        // Filtered data
    onRowClick   // Handler for row selection
  }) => {
    return React.createElement('div', { className: 'bg-white rounded-lg shadow overflow-hidden' },
      React.createElement('table', { className: 'min-w-full divide-y divide-gray-200' },
        // Table Header
        React.createElement('thead', { className: 'bg-gray-50' },
          React.createElement('tr', null,
            columns.map(col => 
              React.createElement('th', {
                key: col.key,
                className: 'px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider'
              }, col.label)
            )
          )
        ),
        // Table Body
        React.createElement('tbody', { className: 'bg-white divide-y divide-gray-200' },
          data.map(item => 
            React.createElement('tr', { 
              key: item.vendorId,
              onClick: () => onRowClick(item),
              className: 'hover:bg-gray-50 cursor-pointer'
            },
              columns.map(col => 
                React.createElement('td', {
                  key: col.key,
                  className: 'px-3 py-2 whitespace-nowrap text-sm text-gray-900'
                }, 
                  col.render ? col.render(item) : (item[col.key] || 'N/A')
                )
              )
            )
          )
        )
      )
    );
  };

  // === Create Vendor Form Component ===
  const CreateVendorForm = ({ onSubmit, onCancel }) => {
    const [formData, setFormData] = React.useState({
      vendorName: '',
      address: '',
      city: '',
      state: '',
      zip: '',
      email: '',
      phone: ''
    });

    const handleSubmit = (e) => {
      e.preventDefault();
      if (!formData.vendorName.trim()) return;
      onSubmit(formData);
    };

    // Phone number formatter
    const formatPhoneNumber = (value) => {
      const cleaned = value.replace(/\D/g, '');
      if (cleaned.length >= 10) {
        return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6,10)}`;
      } else if (cleaned.length > 6) {
        return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
      } else if (cleaned.length > 3) {
        return `(${cleaned.slice(0,3)}) ${cleaned.slice(3)}`;
      } else if (cleaned.length > 0) {
        return `(${cleaned}`;
      }
      return cleaned;
    };

    return React.createElement('div', { className: 'space-y-4 bg-white p-6 rounded-lg shadow' },
      React.createElement('h3', { className: 'text-lg font-semibold' }, 'Create New Vendor'),
      React.createElement('form', { onSubmit: handleSubmit, className: 'space-y-4' },
        // Vendor Name (required)
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Vendor Name *'),
          React.createElement('input', {
            type: 'text',
            required: true,
            value: formData.vendorName,
            onChange: e => setFormData(prev => ({ ...prev, vendorName: e.target.value })),
            className: 'w-full p-2 border rounded'
          })
        ),
        // Address
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Address'),
          React.createElement('input', {
            type: 'text',
            value: formData.address,
            onChange: e => setFormData(prev => ({ ...prev, address: e.target.value })),
            className: 'w-full p-2 border rounded'
          })
        ),
        // City, State, Zip
        React.createElement('div', { className: 'grid grid-cols-3 gap-4' },
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'City'),
            React.createElement('input', {
              type: 'text',
              value: formData.city,
              onChange: e => setFormData(prev => ({ ...prev, city: e.target.value })),
              className: 'w-full p-2 border rounded'
            })
          ),
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'State'),
            React.createElement('input', {
              type: 'text',
              maxLength: 2,
              value: formData.state,
              onChange: e => setFormData(prev => ({ ...prev, state: e.target.value.toUpperCase() })),
              className: 'w-full p-2 border rounded'
            })
          ),
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'ZIP'),
            React.createElement('input', {
              type: 'text',
              maxLength: 5,
              value: formData.zip,
              onChange: e => setFormData(prev => ({ 
                ...prev, 
                zip: e.target.value.replace(/\D/g, '').slice(0, 5)
              })),
              className: 'w-full p-2 border rounded'
            })
          )
        ),
        // Contact Info
        React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Phone'),
            React.createElement('input', {
              type: 'tel',
              value: formData.phone,
              onChange: e => setFormData(prev => ({ 
                ...prev, 
                phone: formatPhoneNumber(e.target.value)
              })),
              className: 'w-full p-2 border rounded'
            })
          ),
          React.createElement('div', null,
            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Email'),
            React.createElement('input', {
              type: 'email',
              value: formData.email,
              onChange: e => setFormData(prev => ({ ...prev, email: e.target.value })),
              className: 'w-full p-2 border rounded'
            })
          )
        ),
        // Buttons
        React.createElement('div', { className: 'flex justify-end space-x-4 pt-4' },
          React.createElement('button', {
            type: 'button',
            onClick: onCancel,
            className: 'px-4 py-2 border rounded hover:bg-gray-50'
          }, 'Cancel'),
          React.createElement('button', {
            type: 'submit',
            className: 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700'
          }, 'Create Vendor')
        )
      )
    );
  };

  // === Main VendorManagement Component ===
  const VendorManagement = ({ showMessage, loading: parentLoading, setLoading: setParentLoading }) => {
    // Remove local loading state, use parent's exclusively
    const setLoading = setParentLoading;
    const mountedRef = React.useRef(true);

    // State management
    const [vendors, setVendors] = React.useState([]);
    const [filteredVendors, setFilteredVendors] = React.useState([]);
    const [selectedVendor, setSelectedVendor] = React.useState(null);
    const [viewMode, setViewMode] = React.useState('list');
    const [isCreating, setIsCreating] = React.useState(false);
    const [searchTerm, setSearchTerm] = React.useState('');
    const [statusFilter, setStatusFilter] = React.useState('All');

    // === Data Fetching with Better Error Handling ===
    const fetchVendors = React.useCallback(() => {
      if (!mountedRef.current) return;
      setLoading(true);

      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(response => {
            if (!mountedRef.current) return;
            if (response && response.success) {
              setVendors(response.data || []);
              setFilteredVendors(response.data || []);
              resolve(response.data);
            } else {
              const error = response?.error || 'Failed to load vendors';
              showMessage(error, 'error');
              reject(new Error(error));
            }
            setLoading(false);
          })
          .withFailureHandler(error => {
            if (!mountedRef.current) return;
            console.error('Error fetching vendors:', error);
            showMessage('Failed to load vendors', 'error');
            setLoading(false);
            reject(error);
          })
          .getVendorsForClient();
      });
    }, [setLoading, showMessage]);

    // Cleanup on unmount
    React.useEffect(() => {
      return () => {
        mountedRef.current = false;
      };
    }, []);

    // Initial fetch with error boundary
    React.useEffect(() => {
      fetchVendors().catch(error => {
        console.error('Error in initial vendor fetch:', error);
      });
    }, [fetchVendors]);

    // === Search and Filter Effect ===
    React.useEffect(() => {
      let filtered = [...vendors];
      
      if (searchTerm.trim()) {
        const searchLower = searchTerm.toLowerCase();
        filtered = filtered.filter(vendor => 
          vendor.vendorName.toLowerCase().includes(searchLower) ||
          vendor.vendorId.toLowerCase().includes(searchLower) ||
          vendor.email?.toLowerCase().includes(searchLower) ||
          vendor.phone?.includes(searchTerm)
        );
      }

      if (statusFilter !== 'All') {
        filtered = filtered.filter(vendor => vendor.status === statusFilter);
      }

      setFilteredVendors(filtered);
    }, [searchTerm, statusFilter, vendors]);

    // === Handlers ===
    const handleCreateVendor = async (formData) => {
      setLoading(true);
      
      try {
        const cleanedData = {
          vendorName: formData.vendorName.trim(),
          address: formData.address.trim(),
          city: formData.city.trim(),
          state: formData.state.trim(),
          zip: formData.zip.trim(),
          email: formData.email.trim(),
          phone: formatPhoneNumber(formData.phone)
        };

        const response = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(result => {
              if (result === null) {
                // Handle null response by fetching latest vendors
                google.script.run
                  .withSuccessHandler(vendorsResult => {
                    if (vendorsResult && vendorsResult.success) {
                      // Find our newly created vendor
                      const foundVendor = vendorsResult.data.find(v => 
                        v.vendorName === cleanedData.vendorName &&
                        v.address === cleanedData.address
                      );
                      if (foundVendor) {
                        resolve({ success: true, data: foundVendor });
                      } else {
                        reject(new Error('Could not verify vendor creation'));
                      }
                    } else {
                      reject(new Error('Failed to verify vendor creation'));
                    }
                  })
                  .withFailureHandler(error => reject(error))
                  .getVendorsForClient();
              } else if (result && result.success) {
                resolve(result);
              } else {
                reject(new Error(result?.error || 'Server returned unsuccessful response'));
              }
            })
            .withFailureHandler(error => {
              console.error('Server error:', error);
              reject(new Error(error.message || 'Failed to create vendor'));
            })
            .createVendorForClient(cleanedData);
        });

        if (response.success) {
          showMessage('Vendor created successfully', 'success');
          setIsCreating(false);
          fetchVendors(); // Refresh list
        } else {
          throw new Error(response.error || 'Failed to create vendor');
        }
      } catch (error) {
        console.error('Error creating vendor:', error);
        showMessage(error.message || 'Error creating vendor', 'error');
      } finally {
        setLoading(false);
      }
    };

    // Phone number formatter
    const formatPhoneNumber = (value) => {
      const cleaned = value.replace(/\D/g, '');
      if (cleaned.length >= 10) {
        return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6,10)}`;
      } else if (cleaned.length > 6) {
        return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
      } else if (cleaned.length > 3) {
        return `(${cleaned.slice(0,3)}) ${cleaned.slice(3)}`;
      } else if (cleaned.length > 0) {
        return `(${cleaned}`;
      }
      return cleaned;
    };

    // === Export Functionality ===
    const exportVendorData = () => {
      const exportData = filteredVendors.map(vendor => ({
        'Vendor ID': vendor.vendorId,
        'Name': vendor.vendorName,
        'Email': vendor.email,
        'Phone': vendor.phone,
        'Total Transactions': vendor.metrics?.totalTransactions || 0,
        'Total Spend': vendor.metrics?.totalSpend || 0,
        'Status': vendor.status || 'N/A'
      }));// Convert to CSV
      const headers = Object.keys(exportData[0]);
      const csvContent = [
        headers.join(','),
        ...exportData.map(row => 
          headers.map(header => 
            JSON.stringify(row[header] || '')
          ).join(',')
        )
      ].join('\n');

      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `vendor_data_${new Date().toISOString()}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    };

    // === Render Methods ===
    const renderHeader = () => {
      return React.createElement('div', { 
        className: 'flex flex-col sm:flex-row justify-between items-center gap-4 mb-6' 
      },
        React.createElement('h2', { 
          className: 'text-xl sm:text-2xl font-bold text-gray-900' 
        }, 'Vendor Management'),
        React.createElement('button', {
          onClick: () => setIsCreating(true),
          className: 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700'
        }, 'Add New Vendor')
      );
    };

    const renderControls = () => {
      return React.createElement('div', { className: 'flex flex-col sm:flex-row justify-between gap-4 mb-6' },
        // Search and filters group
        React.createElement('div', { className: 'flex flex-col sm:flex-row gap-4' },
          React.createElement('input', {
            type: 'text',
            placeholder: 'Search vendors...',
            value: searchTerm,
            onChange: e => setSearchTerm(e.target.value),
            className: 'p-2 border rounded w-full sm:w-64'
          }),
          React.createElement('select', {
            value: statusFilter,
            onChange: e => setStatusFilter(e.target.value),
            className: 'p-2 border rounded w-full sm:w-auto'
          },
            React.createElement('option', { value: 'All' }, 'All Statuses'),
            React.createElement('option', { value: 'Active' }, 'Active'),
            React.createElement('option', { value: 'Inactive' }, 'Inactive')
          )
        )
      );
    };

    // Render vendor details view
    const renderVendorDetails = () => {
      if (!selectedVendor) return null;

      return React.createElement('div', { className: 'space-y-6' },
        // Header with back button
        React.createElement('div', { 
          className: 'flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6' 
        },
          React.createElement('h3', { className: 'text-xl font-bold' }, 
            `${selectedVendor.vendorName} Details`
          ),
          React.createElement('button', {
            onClick: () => {
              setSelectedVendor(null);
              setViewMode('list');
            },
            className: 'inline-flex items-center text-blue-600 hover:text-blue-800'
          }, 
            React.createElement('span', { className: 'mr-2' }, '←'),
            'Back to List'
          )
        ),

        // Contact Information Card
        React.createElement('div', { className: 'bg-white p-4 sm:p-6 rounded-lg shadow-sm' },
          React.createElement('h4', { className: 'font-semibold mb-4' }, 'Contact Information'),
          React.createElement('div', { className: 'grid grid-cols-1 sm:grid-cols-2 gap-4' },
            React.createElement('div', null,
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'Email:'),
              React.createElement('p', null, selectedVendor.email || 'N/A')
            ),
            React.createElement('div', null,
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'Phone:'),
              React.createElement('p', null, selectedVendor.phone || 'N/A')
            ),
            React.createElement('div', null,
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'Address:'),
              React.createElement('p', null, 
                [
                  selectedVendor.address, 
                  selectedVendor.city, 
                  selectedVendor.state, 
                  selectedVendor.zip
                ].filter(Boolean).join(', ') || 'N/A'
              )
            ),
            React.createElement('div', null,
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'Status:'),
              React.createElement('p', null, selectedVendor.status || 'Unknown')
            )
          )
        ),

        // Vendor Metrics Card
        React.createElement('div', { className: 'bg-white p-4 sm:p-6 rounded-lg shadow-sm' },
          React.createElement('h4', { className: 'font-semibold mb-4' }, 'Vendor Metrics'),
          React.createElement('div', { className: 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4' },
            React.createElement('div', null,
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'Total Transactions:'),
              React.createElement('p', { className: 'text-lg font-semibold' }, 
                selectedVendor.metrics?.totalTransactions || 0
              )
            ),
            React.createElement('div', null,
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'Total Spend:'),
              React.createElement('p', { className: 'text-lg font-semibold' }, 
                new Intl.NumberFormat('en-US', {
                  style: 'currency',
                  currency: 'USD'
                }).format(selectedVendor.metrics?.totalSpend || 0)
              )
            ),
            React.createElement('div', null,
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'Average Transaction:'),
              React.createElement('p', { className: 'text-lg font-semibold' }, 
                new Intl.NumberFormat('en-US', {
                  style: 'currency',
                  currency: 'USD'
                }).format(selectedVendor.metrics?.averageTransactionValue || 0)
              )
            ),
            React.createElement('div', null,
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'Last Transaction:'),
              React.createElement('p', { className: 'text-lg font-semibold' }, 
                selectedVendor.metrics?.lastTransactionDate || 'N/A'
              )
            )
          )
        )
      );
    };

    // Render the main view
    return React.createElement('div', { className: 'relative' },
      isCreating
        ? React.createElement(CreateVendorForm, {
            onSubmit: handleCreateVendor,
            onCancel: () => setIsCreating(false)
          })
        : React.createElement('div', { className: 'space-y-6' },
            renderHeader(),
            viewMode === 'details'
              ? renderVendorDetails()
              : React.createElement(React.Fragment, null,
                  renderControls(),
                  React.createElement('div', { className: 'flex justify-end mb-4' },
                    React.createElement('button', {
                      onClick: exportVendorData,
                      className: 'px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700'
                    }, 'Export CSV')
                  ),
                  React.createElement(StandardTable, {
                    columns: [
                      { key: 'vendorId', label: 'ID' },
                      { key: 'vendorName', label: 'Name' },
                      { key: 'email', label: 'Email' },
                      { key: 'phone', label: 'Phone' },
                      { 
                        key: 'status', 
                        label: 'Status', 
                        render: (vendor) => React.createElement('span', {
                          className: `px-2 py-1 rounded text-xs ${
                            vendor.status === 'Active' ? 'bg-green-100 text-green-800' :
                            vendor.status === 'Inactive' ? 'bg-red-100 text-red-800' :
                            'bg-gray-100 text-gray-800'
                          }`
                        }, vendor.status || 'Unknown')
                      }
                    ],
                    data: filteredVendors,
                    onRowClick: (vendor) => {
                      setSelectedVendor(vendor);
                      setViewMode('details');
                    }
                  })
                )
          )
    );
  };

  // Export to global window object
  if (typeof window !== 'undefined') {
    window.VendorManagement = VendorManagement;
  }
})();
</script>