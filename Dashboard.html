<script>
(function() {
  // === Status Constants ===
  const PROJECT_STATUSES = {
    PENDING: 'PENDING',
    APPROVED: 'APPROVED',
    IN_PROGRESS: 'IN_PROGRESS',
    COMPLETED: 'COMPLETED',
    CANCELED: 'CANCELED'
  };

  const ESTIMATE_STATUSES = {
    PENDING: 'PENDING',
    APPROVED: 'APPROVED'
  };

  // Add status transitions map
  const STATUS_TRANSITIONS = {
    PROJECT: {
      [PROJECT_STATUSES.PENDING]: [PROJECT_STATUSES.APPROVED, PROJECT_STATUSES.CANCELED],
      [PROJECT_STATUSES.APPROVED]: [PROJECT_STATUSES.IN_PROGRESS, PROJECT_STATUSES.CANCELED],
      [PROJECT_STATUSES.IN_PROGRESS]: [PROJECT_STATUSES.COMPLETED, PROJECT_STATUSES.CANCELED],
      [PROJECT_STATUSES.COMPLETED]: [],
      [PROJECT_STATUSES.CANCELED]: []
    },
    ESTIMATE: {
      [ESTIMATE_STATUSES.PENDING]: [ESTIMATE_STATUSES.APPROVED],
      [ESTIMATE_STATUSES.APPROVED]: []
    }
  };

  // === Standardized Loading Overlay ===
  const StandardLoadingOverlay = ({ message = 'Loading...' }) => {
    return React.createElement('div', {
      className: 'absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50'
    }, 
      React.createElement('div', { 
        className: 'text-center flex flex-col items-center justify-center' 
      },
        // Spinner SVG
        React.createElement('svg', {
          className: 'animate-spin h-10 w-10 text-blue-600 mb-4',
          xmlns: 'http://www.w3.org/2000/svg',
          fill: 'none',
          viewBox: '0 0 24 24'
        },
          React.createElement('circle', {
            className: 'opacity-25',
            cx: '12',
            cy: '12',
            r: '10',
            stroke: 'currentColor',
            strokeWidth: '4'
          }),
          React.createElement('path', {
            className: 'opacity-75',
            fill: 'currentColor',
            d: 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'
          })
        ),
        // Loading text
        React.createElement('span', { 
          className: 'text-lg text-gray-700 font-semibold' 
        }, message)
      )
    );
  };

  const Dashboard = () => {
    const mountedRef = React.useRef(true);

    // === State Management ===
    const [activeTab, setActiveTab] = React.useState('customers'); // Default to customers tab
    const [loading, setLoading] = React.useState(true);
    const [componentLoading, setComponentLoading] = React.useState(false);
    const [message, setMessage] = React.useState({ text: '', type: '' });
    const [analytics, setAnalytics] = React.useState({
      customers: { total: 0, active: 0 },
      vendors: { total: 0, active: 0 },
      subcontractors: { total: 0, active: 0 },
      projects: { total: 0, active: 0, pending: 0 }
    });
    const [initialized, setInitialized] = React.useState(false);

    // === Message Handler ===
    const showMessage = React.useCallback((text, type = 'info') => {
      if (!mountedRef.current) return;
      setMessage({ text, type });
      setTimeout(() => {
        if (mountedRef.current) {
          setMessage({ text: '', type: '' });
        }
      }, 5000);
    }, []);

    // === Data Fetching ===
    const fetchAnalytics = React.useCallback(() => {
      if (!mountedRef.current) return;
      setLoading(true);
      
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(response => {
            if (!mountedRef.current) return;
            if (response.success) {
              setAnalytics(response.data);
              setLoading(false);
              resolve(response.data);
            } else {
              setLoading(false);
              reject(new Error(response.error || 'Failed to fetch analytics'));
            }
            setInitialized(true);
          })
          .withFailureHandler(error => {
            if (!mountedRef.current) return;
            console.error('Error fetching analytics:', error);
            setLoading(false);
            setInitialized(true);
            reject(error);
          })
          .getDashboardAnalytics();
      });
    }, []);

    // Export functionality
    const exportAnalyticsData = () => {
      const exportData = [
        {
          'Category': 'Customers',
          'Total': analytics.customers.total,
          'Active': analytics.customers.active
        },
        {
          'Category': 'Vendors',
          'Total': analytics.vendors.total,
          'Active': analytics.vendors.active
        },
        {
          'Category': 'Subcontractors',
          'Total': analytics.subcontractors.total,
          'Active': analytics.subcontractors.active
        },
        {
          'Category': 'Projects',
          'Total': analytics.projects.total,
          'Active': analytics.projects.active,
          'Pending': analytics.projects.pending
        }
      ];

      // Convert to CSV
      const headers = Object.keys(exportData[0]);
      const csvContent = [
        headers.join(','),
        ...exportData.map(row => 
          headers.map(header => 
            JSON.stringify(row[header] || '')
          ).join(',')
        )
      ].join('\n');

      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `dashboard_analytics_${new Date().toISOString()}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    };

    // Initial data fetch
    React.useEffect(() => {
      fetchAnalytics();
      return () => {
        mountedRef.current = false;
      };
    }, [fetchAnalytics]);

    // === Tab Rendering ===
    const renderTabs = () => {
      const tabs = [
        { id: 'customers', label: 'Customers', icon: '👥' },
        { id: 'vendors', label: 'Vendors', icon: '🏢' },
        { id: 'subcontractors', label: 'Subcontractors', icon: '🔧' }
      ];

      return React.createElement('div', { className: 'border-b border-gray-200 mb-6 overflow-x-auto' },
        React.createElement('nav', { className: 'flex flex-nowrap min-w-full px-2' },
          tabs.map(tab => 
            React.createElement('button', {
              key: tab.id,
              onClick: () => setActiveTab(tab.id),
              className: `flex-1 min-w-[120px] py-4 px-4 font-medium text-sm border-b-2 flex items-center justify-center gap-2
                ${activeTab === tab.id 
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`
            }, 
              React.createElement('span', { className: 'text-lg sm:text-base' }, tab.icon),
              React.createElement('span', { className: 'hidden sm:inline' }, tab.label)
            )
          )
        )
      );
    };

    // === Analytics Cards ===
    const renderAnalytics = () => {
      const stats = [
        { 
          label: 'Active Projects', 
          value: analytics.projects?.active || 0, 
          color: 'green',
          type: 'project',
          onClick: () => handleItemClick('project', PROJECT_STATUSES.IN_PROGRESS)
        },
        { 
          label: 'Approved Projects', 
          value: analytics.projects?.approved || 0, 
          color: 'yellow',
          type: 'project',
          onClick: () => handleItemClick('project', PROJECT_STATUSES.APPROVED)
        },
        { 
          label: 'Pending Estimates', 
          value: analytics.estimates?.pending || 0, 
          color: 'blue',
          type: 'estimate',
          onClick: () => handleItemClick('estimate', ESTIMATE_STATUSES.PENDING)
        }
      ];

      return React.createElement('div', { 
        className: 'grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6' 
      },
        stats.map(stat => 
          React.createElement('button', { 
            key: stat.label,
            onClick: stat.onClick,
            className: `bg-${stat.color}-50 p-4 rounded-lg border border-${stat.color}-200 
              hover:bg-${stat.color}-100 transition-colors w-full text-left`
          },
            React.createElement('div', { className: 'text-sm text-gray-600' }, stat.label),
            React.createElement('div', { className: 'text-2xl font-bold mt-1' }, stat.value)
          )
        )
      );
    };

    // === Item List Modal ===
    const ItemListModal = ({ isOpen, type, status, onClose }) => {
      const [items, setItems] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);

      const loadItems = React.useCallback(() => {
        if (!isOpen) return;
        setLoading(true);
        setError(null);

        const endpoint = type === 'project' ? 'getProjectsByStatus' : 'getEstimatesByStatus';
        
        console.log(`Fetching ${type}s with status: ${status}`);
        
        google.script.run
          .withSuccessHandler(response => {
            if (!isOpen) return;
            
            console.log(`Raw ${type} response:`, response);
            
            if (!response) {
              console.error(`Null response received for ${type}s`);
              setError(`Failed to fetch ${type}s - null response`);
              setItems([]);
              setLoading(false);
              return;
            }

            // Handle both standardized and legacy response formats
            let processedItems;
            if (Array.isArray(response)) {
              // Handle legacy array response
              processedItems = response;
              console.log(`Processing ${processedItems.length} ${type}s (legacy format)`);
            } else if (response.success && Array.isArray(response.data)) {
              // Handle new standardized response format
              processedItems = response.data;
              console.log(`Processing ${processedItems.length} ${type}s (standard format)`);
            } else {
              console.error(`Invalid response format for ${type}s`);
              setError(`Invalid response format`);
              setItems([]);
              setLoading(false);
              return;
            }

            // Normalize the data structure
            const normalizedItems = processedItems.map(item => ({
              id: item.id || item.projectId || item.estimateId,
              name: type === 'project' ? item.name : `Estimate ${item.id || item.estimateId}`,
              customerName: item.customerName || 'N/A',
              status: item.status,
              projectId: item.projectId,
              estimateId: item.estimateId
            }));

            setItems(normalizedItems);
            setLoading(false);
          })
          .withFailureHandler(error => {
            if (!isOpen) return;
            const errorMsg = error?.message || `Failed to fetch ${type}s`;
            console.error(`Server error fetching ${type}s:`, error);
            setError(errorMsg);
            setItems([]);
            setLoading(false);
          })
          [endpoint](status);
      }, [isOpen, type, status]);

      // Load items when modal opens
      React.useEffect(() => {
        if (isOpen) {
          loadItems();
        }
      }, [isOpen, loadItems]);

      const handleStatusUpdate = async (itemId, newStatus) => {
        setLoading(true);
        
        const endpoint = type === 'project' ? 'updateProjectStatusForClient' : 'updateEstimateStatusForClient';
        const idField = type === 'project' ? 'projectId' : 'estimateId';
        
        try {
          const response = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              [endpoint]({
                [idField]: itemId,
                newStatus
              });
          });

          if (response.success) {
            loadItems(); // Refresh the list after successful update
          } else {
            throw new Error(response.error || 'Update failed');
          }
        } catch (error) {
          console.error('Status update error:', error);
          setError('Failed to update status');
          setLoading(false);
        }
      };

      // Get available status transitions
      const getAvailableStatuses = (currentStatus) => {
        const transitions = STATUS_TRANSITIONS[type.toUpperCase()];
        if (!transitions || !transitions[currentStatus]) {
          return type === 'project' ? Object.values(PROJECT_STATUSES) : Object.values(ESTIMATE_STATUSES);
        }
        return transitions[currentStatus];
      };

      if (!isOpen) return null;

      return React.createElement('div', {
        className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'
      },
        React.createElement('div', {
          className: 'bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto'
        },
          React.createElement('div', { className: 'flex justify-between items-center mb-4' },
            React.createElement('h3', { className: 'text-lg font-semibold' }, 
              `${status} ${type.charAt(0).toUpperCase() + type.slice(1)}s`
            ),
            React.createElement('button', {
              onClick: onClose,
              className: 'text-gray-500 hover:text-gray-700 text-xl'
            }, '×')
          ),
          error ? React.createElement('div', { 
            className: 'text-red-600 mb-4 p-4 bg-red-50 rounded' 
          }, error) : null,
          loading ? 
            React.createElement(StandardLoadingOverlay, { message: `Loading ${type}s...` }) :
            items.length === 0 ?
              React.createElement('div', { 
                className: 'text-center py-8 text-gray-500' 
              }, `No ${status.toLowerCase()} ${type}s found`) :
              React.createElement('table', { className: 'min-w-full divide-y divide-gray-200' },
                React.createElement('thead', { className: 'bg-gray-50' },
                  React.createElement('tr', null,
                    ['ID', 'Name', 'Customer', 'Status', 'Actions'].map(header =>
                      React.createElement('th', {
                        key: header,
                        className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider'
                      }, header)
                    )
                  )
                ),
                React.createElement('tbody', { className: 'bg-white divide-y divide-gray-200' },
                  items.map(item =>
                    React.createElement('tr', { key: item.id || item.projectId || item.estimateId },
                      React.createElement('td', { className: 'px-6 py-4' }, 
                        item.id || item.projectId || item.estimateId
                      ),
                      React.createElement('td', { className: 'px-6 py-4' }, 
                        type === 'project' ? item.name : `Estimate ${item.id}`
                      ),
                      React.createElement('td', { className: 'px-6 py-4' }, 
                        item.customerName
                      ),
                      React.createElement('td', { className: 'px-6 py-4' }, 
                        item.status
                      ),
                      React.createElement('td', { className: 'px-6 py-4' },
                        React.createElement('select', {
                          value: item.status,
                          onChange: (e) => handleStatusUpdate(
                            item.id || item.projectId || item.estimateId, 
                            e.target.value
                          ),
                          className: 'border rounded px-2 py-1'
                        },
                          getAvailableStatuses(item.status).map(value =>
                            React.createElement('option', {
                              key: value,
                              value: value
                            }, value)
                          )
                        )
                      )
                    )
                  )
                )
              )
        )
      );
    };

    // Add state for project list modal
    const [listModal, setListModal] = React.useState({
      isOpen: false,
      type: null,
      status: null
    });

    // Add handler for project card clicks
    const handleItemClick = (type, status) => {
      setListModal({
        isOpen: true,
        type,
        status
      });
    };

    // === Content Rendering ===
    const renderContent = React.useCallback(() => {
      if (!initialized || loading) return null;

      const props = {
        showMessage,
        loading: componentLoading,
        setLoading: setComponentLoading,
        analytics: analytics[activeTab] || {},
        key: activeTab // Add key to force remount on tab change
      };

      // Map tab names to component names explicitly
      const componentMap = {
        customers: 'CustomerManagement',
        vendors: 'VendorManagement',
        subcontractors: 'SubcontractorManagement'
      };

      const componentName = componentMap[activeTab];
      if (!componentName) {
        console.error(`No component mapping for tab: ${activeTab}`);
        return null;
      }

      const Component = window[componentName];
      if (!Component) {
        console.error(`Component ${componentName} not found in window object`);
        return `Loading ${activeTab} component...`;
      }

      return React.createElement(Component, props);
    }, [activeTab, loading, componentLoading, analytics, showMessage, initialized]);

    // === Main Render ===
    return React.createElement('div', { 
      className: 'relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4'
    },
      (loading || componentLoading) && React.createElement(StandardLoadingOverlay, {
        message: loading ? 'Loading Dashboard...' : 'Loading Content...'
      }),
      React.createElement('div', { className: 'space-y-6' },
        // Header and message
        React.createElement('div', { className: 'mb-6' },
          React.createElement('h2', { 
            className: 'text-2xl font-bold text-gray-900' 
          }, 'Management Dashboard'),
          message.text && React.createElement('div', {
            className: `mt-4 p-3 rounded ${
              message.type === 'success' ? 'bg-green-100 text-green-700' :
              message.type === 'error' ? 'bg-red-100 text-red-700' :
              'bg-blue-100 text-blue-700'
            }`
          }, message.text)
        ),
        // Export button
        React.createElement('div', { className: 'flex justify-end mb-4' },
          React.createElement('button', {
            onClick: exportAnalyticsData,
            className: 'px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700'
          }, 'Export Analytics')
        ),
        // Rest of content
        renderTabs(),
        renderAnalytics(),
        React.createElement('div', { 
          className: 'mt-6 bg-gray-50 rounded-lg p-4' 
        }, renderContent())
      ),
      React.createElement(ItemListModal, {
        isOpen: listModal.isOpen,
        type: listModal.type,
        status: listModal.status,
        onClose: () => setListModal({ isOpen: false, type: null, status: null })
      })
    );
  };

  // Export to global window object
  window.Dashboard = Dashboard;
})();
</script>